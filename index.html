<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progetto Farfalle con D3.js by Alessio Prete - Enhanced</title>
    
    <style>
        /* Reset di base per annullare gli stili predefiniti del browser */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Stili generali per il corpo della pagina */
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #667db6 0%, #0082c8 25%, #0082c8 50%, #667db6 100%);
            min-height: 100vh;
            color: white;
            transition: all 0.3s ease; /* Transizione fluida per i cambi di stile */
        }

        /* Stile speciale per il corpo quando la modalit√† inversa √® attiva */
        body.reverse-mode {
			background: linear-gradient(135deg, #b66666 0%, #c80000 25%, #c80000 50%, #b66666 100%);
		}

        /* Contenitore principale per centrare il contenuto */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Stili per l'intestazione della pagina */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); /* Ombra per dare profondit√† al testo */
        }

        /* Box delle istruzioni */
        .instructions {
            background: rgba(255,255,255,0.1); /* Sfondo semi-trasparente */
            backdrop-filter: blur(10px); /* Effetto vetro smerigliato */
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Indicatore della modalit√† (normale/inversa) */
        .mode-indicator {
            position: absolute; /* Posizionato in modo assoluto rispetto alla pagina */
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            opacity: 0; /* Inizialmente invisibile */
        }

        /* Stile per l'indicatore quando √® attivo */
        .mode-indicator.active {
            opacity: 1; /* Diventa visibile */
            transform: scale(1.1); /* Leggero ingrandimento */
        }

        /* Stile specifico per l'indicatore in modalit√† inversa */
        .mode-indicator.reverse {
            background: rgba(255,100,100,0.3);
            border-color: rgba(255,100,100,0.5);
        }

        /* Contenitore per la legenda delle variabili */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Permette alla legenda di andare a capo su schermi piccoli */
        }

        .legend-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Area principale della visualizzazione D3 */
        #visualization {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden; /* Nasconde elementi che potrebbero uscire dai bordi arrotondati */
        }

        /* Stili per i gruppi SVG delle farfalle */
        .butterfly-group {
            cursor: pointer; /* Il cursore diventa una mano */
            transition: all 0.3s ease;
        }

        /* Effetto al passaggio del mouse sulla farfalla */
        .butterfly-group:hover {
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.8)); /* Bagliore bianco */
        }

        .butterfly-group:hover .butterfly-wings {
            stroke-width: 2px;
            stroke: rgba(255,255,255,1);
        }

        /* Classe per l'animazione al click */
        .clicked {
            animation: clickPulse 0.6s ease-out;
        }

        /* Animazione keyframe per il "pulso" al click */
        @keyframes clickPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); filter: drop-shadow(0 0 15px rgba(255,255,255,1)); }
            100% { transform: scale(1); }
        }

        /* Stile per l'effetto "ripple" (onda) al click */
        .click-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            pointer-events: none; /* L'elemento non intercetta i click */
            animation: ripple 0.8s ease-out;
        }

        /* Animazione keyframe per l'onda */
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Contenitore per le statistiche (conteggio click) */
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 120px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Box per la visualizzazione dei valori delle variabili */
        .variable-display {
            margin-top: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .variable-display h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 300;
        }

        /* Griglia per i valori delle singole variabili */
        .variables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Layout responsive */
            gap: 15px;
        }

        .variable-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .variable-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .variable-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4ECDC4; /* Colore personalizzato per i valori */
            transition: all 0.3s ease;
        }

        /* Classe per animare il cambio di valore */
        .variable-value.changed {
            animation: valueChange 0.6s ease-out;
        }

        /* Animazione keyframe per il cambio di valore */
        @keyframes valueChange {
            0% { color: #FF6B6B; transform: scale(1.2); }
            100% { color: #4ECDC4; transform: scale(1); }
        }
		
		/* Stile per il footer */
		footer {
			text-align: center;
			padding: 40px 20px;
			color: white;
			opacity: 0.8;
			font-size: 0.9rem;
		}

    </style>
</head>
<body>
    <div class="container">
        <div class="mode-indicator" id="modeIndicator">
            <span id="modeText">Modalit√† Normale</span>
        </div>
        
        <div class="header">
            <h1>ü¶ã Progetto Farfalle Interattive</h1>
            <div class="instructions">
                <p><strong>Clicca su una farfalla</strong> per ruotare le variabili in senso orario</p>
                <p><strong>Tieni premuto 'R' e clicca</strong> per ruotare in senso antiorario</p>
            </div>
            
            <div class="legend">
                <div class="legend-item">üìç <strong>Posizione X:</strong> Variabile 1</div>
                <div class="legend-item">üìç <strong>Posizione Y:</strong> Variabile 2</div>
                <div class="legend-item">üïäÔ∏è <strong>Ali:</strong> Variabile 3 (grandezza)</div>
                <div class="legend-item">üî¥ <strong>Testa:</strong> Variabile 4 (cerchio nero in alto)</div>
                <div class="legend-item">üìè <strong>Addome:</strong> Variabile 5 (spessore corpo centrale)</div>
            </div>
        </div>

        <div id="visualization"></div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="clickCount">0</div>
                <div class="stat-label">Click Totali</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="normalClicks">0</div>
                <div class="stat-label">Rotazioni Normali</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="reverseClicks">0</div>
                <div class="stat-label">Rotazioni Inverse</div>
            </div>
        </div>
        
        <div class="variable-display">
    <h3>üîÑ Valori Attuali delle Variabili (Tutte le Farfalle)</h3>
    <div id="allVariables"></div>
</div>

    </div>

<script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // ===================================
        // === SEZIONE DI CONFIGURAZIONE D3 ===
        // ===================================

        // Definizione di margini e dimensioni per l'area di disegno SVG
        const margin = { top: 40, right: 40, bottom: 40, left: 40 };
        const width = 1000 - margin.left - margin.right;
        const height = 700 - margin.top - margin.bottom;

        // Selezione del div '#visualization' e aggiunta di un elemento SVG
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g") // Aggiunta di un gruppo <g> per gestire i margini
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // =======================
        // === DEFINIZIONE DATI ===
        // =======================
		
		
		//Lettura dataset .json
        let dataset = [];

		d3.json("dataset.json").then(data => {
			dataset = data;
			computeDomains(dataset);
			drawButterflies(dataset);
			updateStats();
			updateModeIndicator();
		});
		
		function computeDomains(dataset) {
			// Calcola min/max per ciascuna delle 5 variabili
			const numVars = dataset[0].vars.length;
			const newDomains = [];

			for (let i = 0; i < numVars; i++) {
				const values = dataset.map(d => d.vars[i]);
				newDomains.push([d3.min(values), d3.max(values)]);
			}

			domains = newDomains; // aggiorna l'array globale dei domini
		}



        // ==========================
        // === VARIABILI GLOBALI ===
        // ==========================

        let isRPressed = false; // Flag per controllare se il tasto 'R' √® premuto
        let clickCount = 0;     // Contatore click totali
        let normalClicks = 0;   // Contatore click normali
        let reverseClicks = 0;  // Contatore click in modalit√† inversa
		
        // Riferimenti agli elementi HTML per l'indicatore di modalit√†
		const modeIndicator = document.getElementById('modeIndicator');
		const modeText = document.getElementById('modeText');
		const body = document.body;

        // =================================
        // === SCALE E DOMINI DINAMICI ===
        // =================================

        // Definizione delle scale lineari di D3. Ogni scala mappa un intervallo di dati (domain)
        // a un intervallo di pixel (range).
        const xScale = d3.scaleLinear().range([80, width - 80]);
        const yScale = d3.scaleLinear().range([80, height - 80]);
        const wingScale = d3.scaleLinear().range([15, 50]);
        const headScale = d3.scaleLinear().range([4, 12]);
        const abdomenScale = d3.scaleLinear().range([15, 35]);
        const bodyWidthScale = d3.scaleLinear().range([2, 5]);
        
        // Questo array ruoter√† in sincronia con i dati.
        let domains = [];

        // Funzione per aggiornare i domini di tutte le scale basandosi sull'array 'domains'.
        function updateScaleDomains() {
            xScale.domain(domains[0]);
            yScale.domain(domains[1]);
            wingScale.domain(domains[2]);
            headScale.domain(domains[3]);
            abdomenScale.domain(domains[4]);
            bodyWidthScale.domain(domains[4]); // La larghezza del corpo condivide il dominio dell'addome
        }

        // Scala di colori per assegnare un colore unico e fisso a ogni farfalla.
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(dataset.map(d => d.id));

        // =========================================
        // === FUNZIONI DI DISEGNO DELLA FARFALLA ===
        // =========================================

        // Funzione che crea il percorso SVG per le ali.
        function createWings(d) {
            const wing = wingScale(d.vars[2]);
            const head = headScale(d.vars[3]);
            const abdomen = abdomenScale(d.vars[4]);
            // Ritorna una stringa di comandi SVG path
            return `M 0,${-head*2} C ${wing*1.2},${-wing*0.6},${wing},${wing*0.2},0,${head} M 0,${head} C ${wing*0.8},${wing*0.4},${wing*0.6},${abdomen*0.4},0,${abdomen} M 0,${-head*2} C ${-wing*1.2},${-wing*0.6},${-wing},${wing*0.2},0,${head} M 0,${head} C ${-wing*0.8},${wing*0.4},${-wing*0.6},${abdomen*0.4},0,${abdomen}`;
        }

        // Funzione che crea il percorso SVG per il pattern sulle ali.
        function createWingPattern(d) {
            const wing = wingScale(d.vars[2]);
            return `M ${-wing*0.6},${-wing*0.3} C ${-wing*0.7},${-wing*0.1},${-wing*0.6},${wing*0.1},${-wing*0.4},${wing*0.2} M ${wing*0.6},${-wing*0.3} C ${wing*0.7},${-wing*0.1},${wing*0.6},${wing*0.1},${wing*0.4},${wing*0.2}`;
        }

        // ======================================
        // === FUNZIONE PRINCIPALE DI DISEGNO ===
        // ======================================

        function drawButterflies(data) {
            // 1. Aggiorna i domini delle scale prima di qualsiasi operazione di disegno
            updateScaleDomains();

            // 2. Data Join: lega i dati 'data' ai gruppi con classe '.butterfly-group'
            const butterflies = svg.selectAll(".butterfly-group").data(data, d => d.id); // d.id √® la chiave per riconoscere gli elementi

            // 3. Enter Selection: gestisce i nuovi dati per cui non esistono ancora elementi SVG
            const butterfliesEnter = butterflies.enter().append("g") // Crea un gruppo <g> per ogni nuova farfalla
                .attr("class", "butterfly-group")
                .on("click", handleButterflyClick) // Associa l'evento click
                .attr("transform", d => `translate(${xScale(d.vars[0])}, ${yScale(d.vars[1])})`); // Posiziona inizialmente

            // Aggiunge le varie parti della farfalla al gruppo appena creato
            butterfliesEnter.append("path").attr("class", "butterfly-wings").attr("d", createWings);
            butterfliesEnter.append("path").attr("class", "wing-pattern").attr("d", createWingPattern);
            butterfliesEnter.append("circle").attr("class", "butterfly-head").attr("r", d => headScale(d.vars[3])).attr("cy", d => -headScale(d.vars[3]) * 2.5);
            butterfliesEnter.append("line").attr("class", "butterfly-body").attr("y1", d => -headScale(d.vars[3]) * 2).attr("y2", d => abdomenScale(d.vars[4])).attr("stroke-width", d => bodyWidthScale(d.vars[4]));
            butterfliesEnter.append("line").attr("class", "antenna-left");
            butterfliesEnter.append("line").attr("class", "antenna-right");

            // 4. Merge Selection: unisce gli elementi nuovi (enter) con quelli gi√† esistenti (update)
            const allButterflies = butterflies.merge(butterfliesEnter);

            // 5. Update Selection: applica stili e transizioni a tutti gli elementi (nuovi e vecchi)
            
            // Applica stili statici che non cambiano con la transizione (es. colore)
            allButterflies.select(".butterfly-wings").attr("fill", d => colorScale(d.id)).attr("stroke", d => d3.color(colorScale(d.id)).darker(0.5));
            allButterflies.select(".wing-pattern").attr("stroke", d => d3.color(colorScale(d.id)).darker(1.5));
            allButterflies.select(".butterfly-head").attr("fill", "#2c3e50");
            allButterflies.select(".butterfly-body").attr("stroke", "#2c3e50").attr("stroke-linecap", "round");
            allButterflies.selectAll(".antenna-left, .antenna-right").attr("stroke", "#2c3e50").attr("stroke-width", 1.5);

            // Applica le transizioni animate per posizione e forma
            allButterflies.transition().duration(1500).ease(d3.easeCubicInOut) // Transizione di 1.5 secondi
                .attr("transform", d => `translate(${xScale(d.vars[0])}, ${yScale(d.vars[1])})`);

            allButterflies.select(".butterfly-wings").transition().duration(1500).ease(d3.easeCubicInOut).attr("d", createWings);
            allButterflies.select(".wing-pattern").transition().duration(1500).ease(d3.easeCubicInOut).attr("d", createWingPattern);
            allButterflies.select(".butterfly-head").transition().duration(1500).ease(d3.easeCubicInOut).attr("r", d => headScale(d.vars[3])).attr("cy", d => -headScale(d.vars[3]) * 2.5);
            allButterflies.select(".butterfly-body").transition().duration(1500).ease(d3.easeCubicInOut).attr("y1", d => -headScale(d.vars[3]) * 2).attr("y2", d => abdomenScale(d.vars[4])).attr("stroke-width", d => bodyWidthScale(d.vars[4]));
            allButterflies.select(".antenna-left").transition().duration(1500).ease(d3.easeCubicInOut).attr("x1", d => -headScale(d.vars[3])*0.7).attr("y1", d => -headScale(d.vars[3])*3).attr("x2", d => -headScale(d.vars[3])*1.5).attr("y2", d => -headScale(d.vars[3])*4);
            allButterflies.select(".antenna-right").transition().duration(1500).ease(d3.easeCubicInOut).attr("x1", d => headScale(d.vars[3])*0.7).attr("y1", d => -headScale(d.vars[3])*3).attr("x2", d => headScale(d.vars[3])*1.5).attr("y2", d => -headScale(d.vars[3])*4);
        }

        // ========================
        // === GESTIONE EVENTI ===
        // ========================

        // Funzione chiamata al click su una farfalla
        function handleButterflyClick(event, d) {
            // Aggiorna i contatori dei click
            clickCount++;
            isRPressed ? reverseClicks++ : normalClicks++;
            
            // 1. Ruota fisicamente i dati nell'array 'vars' di ogni farfalla
            dataset.forEach(butterfly => {
                if (isRPressed) { // Se 'R' √® premuto, rotazione inversa
                    const last = butterfly.vars.pop(); // Rimuove l'ultimo elemento
                    butterfly.vars.unshift(last);      // e lo inserisce all'inizio
                } else { // Altrimenti, rotazione normale
                    const first = butterfly.vars.shift(); // Rimuove il primo elemento
                    butterfly.vars.push(first);         // e lo inserisce alla fine
                }
            });

            // 2. Ruota l'array dei domini delle scale in modo corrispondente
            if (isRPressed) {
                const lastDomain = domains.pop();
                domains.unshift(lastDomain);
            } else {
                const firstDomain = domains.shift();
                domains.push(firstDomain);
            }

            // 3. Chiama la funzione di disegno per applicare i cambiamenti
            drawButterflies(dataset);
            // Aggiorna le statistiche visualizzate a schermo
            updateStats();
        }
        
        // Funzione per aggiornare i contatori nella UI
        function updateStats() {
            document.getElementById('clickCount').textContent = clickCount;
            document.getElementById('normalClicks').textContent = normalClicks;
            document.getElementById('reverseClicks').textContent = reverseClicks;
            updateVariableDisplay(); // Chiama l'aggiornamento dei valori delle variabili
        }
		
		// Funzione per aggiornare l'indicatore visuale della modalit√†
		function updateModeIndicator() {
			if (isRPressed) {
				modeIndicator.classList.add('active', 'reverse');
				modeText.textContent = 'üîÑ Modalit√† Inversa (R)';
				body.classList.add('reverse-mode');
			} else {
				modeIndicator.classList.remove('active', 'reverse');
				modeText.textContent = 'Modalit√† Normale';
				body.classList.remove('reverse-mode');
			}
		}

        // Funzione per aggiornare i valori mostrati nel pannello in basso
       /* function updateVariableDisplay() {
			const container = document.getElementById('allVariables');
			container.innerHTML = ""; // Pulisce

			dataset.forEach(butterfly => {
				const varsHtml = butterfly.vars
					.map((v, i) => `<div class="variable-item">
										<div class="variable-label">Var ${i+1}</div>
										<div class="variable-value">${v}</div>
									</div>`)
					.join("");

				container.innerHTML += `
					<div style="margin-bottom:15px; padding:10px; border:1px solid rgba(255,255,255,0.2); border-radius:10px;">
						<strong>Farfalla #${butterfly.id}</strong>
						<div class="variables-grid">
							${varsHtml}
						</div>
					</div>
				`;
			});
		} */
		function updateVariableDisplay() {
			const colorNames = {
			1: "blu",
			2: "verde",
			3: "viola",
			4: "rosa",
			5: "arancione",
			6: "rossa",
			7: "marrone",
			8: "grigia"
		};

			const container = document.getElementById('allVariables');

			// Se √® la prima volta, crea tutta la struttura HTML
			if (!container.hasChildNodes()) {
				dataset.forEach(butterfly => {
					const butterflyBlock = document.createElement("div");
					butterflyBlock.classList.add("butterfly-variables");
					butterflyBlock.style.marginBottom = "15px";
					butterflyBlock.style.padding = "10px";
					butterflyBlock.style.border = "1px solid rgba(255,255,255,0.2)";
					butterflyBlock.style.borderRadius = "10px";

					const title = document.createElement("strong");
					title.textContent = `Farfalla ${colorNames[butterfly.id]}`;
					butterflyBlock.appendChild(title);

					const varsGrid = document.createElement("div");
					varsGrid.classList.add("variables-grid");

					butterfly.vars.forEach((v, i) => {
						const varItem = document.createElement("div");
						varItem.classList.add("variable-item");

						const label = document.createElement("div");
						label.classList.add("variable-label");
						label.textContent = `Var ${i + 1}`;

						const value = document.createElement("div");
						value.classList.add("variable-value");
						value.id = `butterfly${butterfly.id}-var${i+1}`;
						value.textContent = v;

						varItem.appendChild(label);
						varItem.appendChild(value);
						varsGrid.appendChild(varItem);
					});

					butterflyBlock.appendChild(varsGrid);
					container.appendChild(butterflyBlock);
				});
			} else {
				// Aggiorna valori esistenti con animazione
				dataset.forEach(butterfly => {
					butterfly.vars.forEach((v, i) => {
						const valueEl = document.getElementById(`butterfly${butterfly.id}-var${i+1}`);
						if (valueEl.textContent != v) {
							valueEl.classList.add("changed");
							valueEl.textContent = v;
							// Rimuove la classe dopo l‚Äôanimazione
							setTimeout(() => valueEl.classList.remove("changed"), 600);
						}
					});
				});
			}
		}



        // Listener per l'evento 'keydown' (pressione di un tasto)
        window.addEventListener('keydown', (e) => {
			if (e.key.toLowerCase() === 'r' && !isRPressed) { // Se premuto 'r'
				isRPressed = true; // Imposta il flag
				updateModeIndicator(); // Aggiorna la UI
			}
		});

        // Listener per l'evento 'keyup' (rilascio di un tasto)
		window.addEventListener('keyup', (e) => {
			if (e.key.toLowerCase() === 'r') { // Se rilasciato 'r'
				isRPressed = false; // Resetta il flag
				updateModeIndicator(); // Aggiorna la UI
			}
		});

        // ======================
        // === INIZIALIZZAZIONE ===
        // ======================
        // Chiamate iniziali per disegnare le farfalle e impostare i valori al caricamento della pagina
		updateModeIndicator();
    </script>
	<footer>
    <p>Made by Alessio Prete</p>
	</footer>
</body>
</html>